<div class="col-md-6">
  <h2>Listings Found: </h2>

    <%= form_tag(properties_path, :method => "get", id: "search-form") do %>
    <%= text_field_tag :search, params[:search], placeholder: "Enter address or property type", :class => "form-control" %>
    <span><%= submit_tag "Search", :name => nil, :class => "btn btn-default" %></span>
  <% end %>
<br>

  <div class="btn-group sortButton">
          <button type="button" class="btn btn-primary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Sort<span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li><a href="#" class = "lowPrice">Lowest Price</a></li>
            <li><a href="#" class = "highPrice">Highest Price</a></li>
            <li><a href="#" class = "recency">Recency</a></li>
            <li><a href="#" class = "popularity">Popularity</a></li>
          </ul>
        </div>
  <br><br>

  <div class="propPanel "style="overflow-y: scroll; height:350px;">
    <% if @properties.blank? %>
    <h4>There are no property containing the address or property type <%= params[:search] %>.</h4>
  <% end %>
    <%@properties.each do |prop|%>
      <div class="row sortProps" style="margin-bottom: 25px;">

        <div class="col-md-4">
          <%= cl_image_tag(prop.photo_url, :width => 180, :height => 170, :alt => "Property Pic") %>
        </div>
        <div class="col-md-4">
          <p class="propAddr" style="font-weight:bold;"><%=prop.address%></p>
          <p>S<%=prop.postcode%></p>
          <p><%=prop.property_type%>, <%=prop.rent_area%></p>


          <p><i>Listed at: <span><%=prop.updated_at.to_s[0..18]%></span></i></p>
        </div>
        <div class="col-md-4">
          <p><b>$<span class="propPrice"><%=prop.price%></span> /month</b></p>
          <p>Popularity: <span class="propPop"><%=prop.shortlists.length%></span></p>
          <p style="display:none;"class="propTime">
            <%=Time.zone.parse(prop.updated_at.to_s).to_i%>
          <p>
          <p style="display:none;"class="propLat">
            <%=prop.latitude%>
          <p>
          <p style="display:none;"class="propLng">
            <%=prop.longitude%>
          <p>
        </div>

      </div>
    <%end%>
  </div>
</div>
<div class="col-md-6">
  <h2>Google Map API</h2>
  <div id="map" style="height:400px;width:100%;"></div>
</div>
<script>


  function initMap() {
    var map;
    var markerArray = []

    if(<%=@center_map%>){
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 11,
        center: {lat: 1.384323,lng: 103.826093}
      });
    }
    else{
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: {lat: <%=@geocode[0][0]%>,lng: <%=@geocode[0][1]%>}
      });
    }
    var prev_infowindow =false;

    <%=@geocode.to_json.html_safe%>.forEach(function(arr){
      var marker = new google.maps.Marker({
        position: {lat:arr[0],lng:arr[1]},
        map: map
      })
      var infowindow = new google.maps.InfoWindow({
        content: arr[2]
      });

      markerArray.push([marker,arr[2],infowindow])
      // var closeWindow = true
      // marker.addListener('mouseover', function() {
      //     infowindow.setContent(arr[2])
      //     closeWindow = true
      //   infowindow.open(map, this)
      // })
      // marker.addListener('mouseout', function() {
      //   if(closeWindow){
      //     infowindow.close()
      //   }
      // })

      marker.addListener('click', function() {
        if(prev_infowindow) {
             prev_infowindow.close();
          }
        prev_infowindow = infowindow
        // closeWindow = false
        infowindow.open(map, this)
        var $highlightedDiv = $('div p:contains('+arr[2]+')').parent('div').parent('div')
        var $otherDiv = $('div p:contains('+arr[2]+')').parent('div').parent('div').siblings()
        $otherDiv.hide()
        $highlightedDiv.show()
      })

      infowindow.addListener('closeclick', function() {
        var $otherDiv = $('div p:contains('+arr[2]+')').parent('div').parent('div').siblings()
        $otherDiv.show()
        console.log('closing')
        // closeWindow = true
      })
    })
    function centrePin () {
      var $propLatitude = parseFloat($(this).find('.propLat').text())
      var $propLongitude = parseFloat($(this).find('.propLng').text())
      // console.log("latitude is "+ $propLatitude + " and longitude is "+ $propLongitude)
      map.panTo(new google.maps.LatLng($propLatitude, $propLongitude))

      var $propAddress = $(this).find('.propAddr').text()
      var relatedMarker = markerArray.find(function(elm){return elm.includes($propAddress)})[0]

      google.maps.event.trigger(relatedMarker, 'click');
    }

    function originalPan(){
      console.log("original pan!")
      if(<%=@center_map%>){
        var $propLatitude = 1.384323
        var $propLongitude = 103.826093
      }
      else{
        var $propLatitude = <%=@geocode[0][0]%>
        var $propLongitude = <%=@geocode[0][1]%>
      }
      map.panTo(new google.maps.LatLng($propLatitude, $propLongitude))

      var $propAddress = $(this).find('.propAddr').text()
      var relatedInfoWindow = markerArray.find(function(elm){return elm.includes($propAddress)})[2]
      google.maps.event.trigger(relatedInfoWindow, 'closeclick');
    }

    $(document).on('mouseenter', '.sortProps', {}, centrePin)
    $(document).on('mouseleave', '.sortProps', {}, originalPan)

  }


</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyClU-x_i5Nq9B1Q1qRuSJ0_0nKLdf41q8g&callback=initMap">
</script>
